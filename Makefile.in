#
# This makefile simply redirects all targets to "src" directory, but also includes
# some specific package-wide rules.
#
# http://mad-scientist.net/make/rules.html

include Makefile.inc

# These targets are used to invoke make recursively but do some additional actions if necessary:
SPECIAL_PHONY_TARGETS	:= $(addsuffix .subdir,$(PHONY_TARGETS))

.PHONY: proper tarball dist pkgdeb pkgrpm $(SPECIAL_PHONY_TARGETS)

$(SPECIAL_PHONY_TARGETS): %.subdir:
	$(MAKE) -C src $*
	$(MAKE) -C dict $*
	$(MAKE) -C doc $*

all: all.subdir

install: install.subdir
	$(INSTALL_DIR) $(DESTDIR)$(docdir)
	$(INSTALL_DATA) README $(DESTDIR)$(docdir)

uninstall: uninstall.subdir
	$(RM) -f $(DESTDIR)$(docdir)/README
#	We do not uninstall empty directories

# Should remove all Makefile targets:
clean: clean.subdir

# Cleanup all autogenerated files (e.g. used before creating a distro tarball).
distclean: clean distclean.subdir
	$(RM) -f config.status config.cache config.log
	$(RM) -f Makefile Makefile.inc
	$(RM) -rf autom4te.cache

# This rule is responsible for correcting permissions after checkout from VCS.
proper:
	chmod 755 configure

# This rule creates a tarball from current directory.
# $(TAR_NAME) should be defined before calling this rule:
tarball: distclean proper
	tar -C .. -czf $(TAR_NAME) --exclude-vcs $(shell basename `pwd`)

# Create a tarball snapshot from current source directory (usually to be uploaded to FTP server).
dist: TAR_NAME := ../$(name_version).tgz
# Generate md5:
dist: tarball
	cat $(TAR_NAME) | md5sum  > $(TAR_NAME).md5
	@echo "Archive $(TAR_NAME) was created."

# Use default value if TMP variable is not defined:
#BUILD_DIR := $(shell echo $${TMP:-/tmp})/$(name_version)
# The above definition of build directory is not perfect, as Hudson will not capture the build artifacts. So we use the relative path:
pkgdeb: BUILD_DIR := ../build/$(name_version)

# Create DEB package:
pkgdeb:
	$(RM) -rf $(BUILD_DIR)
	
	mkdir -p $(BUILD_DIR)
	
	cp -a . $(BUILD_DIR)
	cp -a package/linux/debian $(BUILD_DIR)
	
#	Debian build requires the original tarball name to correspond to mask "NAME_VERSION.orig.(tar|tar.bz2|tar.gz|lzma)":	
	TAR_NAME=../$(name)_$(version).orig.tar.gz $(MAKE) -C $(BUILD_DIR) tarball 
	cd $(BUILD_DIR) && debuild -sa

# %_topdir should refer the absolute path:
pkgrpm: BUILD_DIR := $(shell pwd)/../build

# Create RPM package:
pkgrpm: 
	$(RM) -rf $(BUILD_DIR)
	
	echo "%_topdir $(BUILD_DIR)" > ~/.rpmmacros
	echo "%name $(name)" >> ~/.rpmmacros
	echo "%version $(version)" >> ~/.rpmmacros
	
	mkdir -p $(BUILD_DIR)/{SOURCES,SPECS,BUILD,RPMS,SRPMS,$(name_version)}
	
	cp -a . $(BUILD_DIR)/$(name_version)
	
#	If you change the tarname here, change also "Source0" in package/linux/suse/osra.spec:
	TAR_NAME=$(BUILD_DIR)/SOURCES/$(name_version).tar.gz $(MAKE) -C $(BUILD_DIR)/$(name_version) tarball
	cp package/linux/suse/osra.spec $(BUILD_DIR)/SPECS
	cd $(BUILD_DIR)/SPECS && rpmbuild -ba --target=$(TARGET_CPU) osra.spec; exit_code=$$?; $(RM) -f ~/.rpmmacros; exit $$exit_code; 

beautify:
	astyle --style=gnu --suffix=none --recursive "*.cpp" "*.h"

Makefile.inc: Makefile.inc.in config.status
	./config.status

config.status: configure
	./configure

configure: configure.ac aclocal.m4
	autoconf

